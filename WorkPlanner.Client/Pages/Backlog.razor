@page "/backlog"

<PageTitle>Backlog - WorkPulse</PageTitle>

<MudText Typo="Typo.h3" GutterBottom="true">Backlog</MudText>

<MudStack Spacing="2">
    <MudSelect T="int" Label="Project" Dense="true" @bind-Value="SelectedProjectId">
        @if (Projects.Count == 0)
        {
            <MudSelectItem T="int" Value="0">No projects available</MudSelectItem>
        }
        else
        {
            @foreach (var project in Projects)
            {
                <MudSelectItem T="int" Value="project.Id">@project.Name</MudSelectItem>
            }
        }
    </MudSelect>

    <MudSelect T="string" Label="Assignee" Dense="true" @bind-Value="SelectedAssigneeId">
        <MudSelectItem T="string" Value="@AssigneeFilterAll">All</MudSelectItem>
        <MudSelectItem T="string" Value="@AssigneeFilterMe">Me</MudSelectItem>
        <MudSelectItem T="string" Value="@AssigneeFilterUnassigned">Unassigned</MudSelectItem>
        @foreach (var member in Members)
        {
            <MudSelectItem T="string" Value="member.UserId">@member.FullName</MudSelectItem>
        }
    </MudSelect>

    <MudStack Spacing="2">
        <MudText Typo="Typo.subtitle1">Backlog</MudText>
        <MudPaper Class="pa-4" Style="min-height: 120px;"
                  @ondragover:preventDefault
                  @ondrop="(() => OnDropToBacklog())">
            @if (IsUnauthorized)
            {
                <MudAlert Severity="Severity.Warning">Login required to view backlog.</MudAlert>
            }
            else if (BacklogTasks.Count == 0)
            {
                <MudText Typo="Typo.body2" Color="Color.Secondary">No tasks in backlog.</MudText>
            }
            else
            {
                @foreach (var task in FilteredBacklogTasks)
                {
                    <div class="pa-2 mb-2" draggable="true"
                         @ondragstart="(() => OnDragStart(task))">
                        <MudText>@task.Title</MudText>
                    </div>
                }
            }
        </MudPaper>

        @foreach (var sprint in Sprints)
        {
            <MudText Typo="Typo.subtitle1">@sprint.Name (@sprint.StartDate.ToString("yyyy-MM-dd") - @sprint.EndDate.ToString("yyyy-MM-dd"))</MudText>
            <MudPaper Class="pa-4" Style="min-height: 120px;"
                      @ondragover:preventDefault
                      @ondrop="(() => OnDropToSprint(sprint.Id))">
                @if (IsUnauthorized)
                {
                    <MudAlert Severity="Severity.Warning">Login required to view sprint tasks.</MudAlert>
                }
                else if (!SprintTasks.ContainsKey(sprint.Id) || SprintTasks[sprint.Id].Count == 0)
                {
                    <MudText Typo="Typo.body2" Color="Color.Secondary">No tasks in this sprint.</MudText>
                }
                else
                {
                    @foreach (var task in FilteredSprintTasks(sprint.Id))
                    {
                        <div class="pa-2 mb-2" draggable="true"
                             @ondragstart="(() => OnDragStart(task))">
                            <MudText>@task.Title</MudText>
                        </div>
                    }
                }
            </MudPaper>
        }
    </MudStack>
</MudStack>
